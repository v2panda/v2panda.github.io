<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> AFNetworking 源码阅读笔记（一） · v2panda's blog</title><meta name="description" content="AFNetworking 源码阅读笔记（一） - 熊猫"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/v2panda.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://v2panda.com/atom.xml" title="v2panda's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/v2panda.ico" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="http://weibo.com/xzlovepanda" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/v2panda" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">AFNetworking 源码阅读笔记（一）</h1><div class="post-info">Sep 26, 2016</div><div class="post-content"><p><img src="http://7xnmlk.com1.z0.glb.clouddn.com/afnetworking-logo.png" alt="AFNetworking"><br><a href="https://github.com/AFNetworking/AFNetworking/" target="_blank" rel="external">AFNetworking</a> 是 Objective-C 中用于网络请求的第三方框架，我们一般使用它来封装网络请求，这篇文章记录了阅读 AFNetworking(Version 3.1.0) 源码的笔记，简单的研究了它的实现细节。</p>
<a id="more"></a>
<h3 id="前言">前言</h3><p>这里引用 <a href="https://github.com/Draveness" target="_blank" rel="external">@draveness</a> 的一张图来展示 AFNetworking 的整个架构：</p>
<p><img src="http://7xnmlk.com1.z0.glb.clouddn.com/afnetworking-arch.png" alt=""></p>
<p>本系列以此架构为依据，随后的文章会逐一分析 AFNetworking 的实现原理。</p>
<h3 id="流程">流程</h3><p>首先以<a href="https://github.com/AFNetworking/AFNetworking/" target="_blank" rel="external">官方 Demo</a> 中的一个 Get 方法为例，来探究 AFNetworking 网络请求的大致流程。</p>
<p><img src="http://7xnmlk.com1.z0.glb.clouddn.com/Get+%E6%96%B9%E6%B3%95.png" alt=""></p>
<ul>
<li>1.Get 请求入口 </li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)GET:(<span class="built_in">NSString</span> *)URLString</span><br><span class="line">                   parameters:(<span class="keyword">id</span>)parameters</span><br><span class="line">                      success:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> *task, <span class="keyword">id</span> responseObject))success</span><br><span class="line">                      failure:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> *task, <span class="built_in">NSError</span> *error))failure</span><br></pre></td></tr></table></figure>
<ul>
<li>2.创建 NSURLSessionDataTask </li>
</ul>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">NSURLSessionDataTask</span> *)dataTaskWithHTTPMethod:(<span class="type">NSString</span> *)<span class="keyword">method</span></span><br><span class="line">                                       <span class="type">URLString</span>:(<span class="type">NSString</span> *)<span class="type">URLString</span></span><br><span class="line">                                      parameters:(id)parameters</span><br><span class="line">                                  uploadProgress:(nullable <span class="type">void</span> (^)(<span class="type">NSProgress</span> *uploadProgress)) uploadProgress</span><br><span class="line">                                downloadProgress:(nullable <span class="type">void</span> (^)(<span class="type">NSProgress</span> *downloadProgress)) downloadProgress</span><br><span class="line">                                         success:(<span class="type">void</span> (^)(<span class="type">NSURLSessionDataTask</span> *, id))success</span><br><span class="line">                                         failure:(<span class="type">void</span> (^)(<span class="type">NSURLSessionDataTask</span> *, <span class="type">NSError</span> *))failure</span><br></pre></td></tr></table></figure>
<ul>
<li>3.创建 NSURLSessionDataTask 前先创建 NSMutableURLRequest </li>
</ul>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (NSMutableURLRequest *)requestWithMethod:(NSString *)<span class="function"><span class="keyword">method</span></span><br><span class="line">                                 <span class="title">URLString</span>:</span>(NSString *)URLString</span><br><span class="line">                                parameters:(id)parameters</span><br><span class="line">                                     error:(NSError *__autoreleasing *)error</span><br></pre></td></tr></table></figure>
<ul>
<li>4.用 request 创建 NSURLSessionDataTask </li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                               uploadProgress:(nullable <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgressBlock</span><br><span class="line">                             downloadProgress:(nullable <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgressBlock</span><br><span class="line">                            completionHandler:(nullable <span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> _Nullable responseObject,  <span class="built_in">NSError</span> * _Nullable error))completionHandler</span><br></pre></td></tr></table></figure>
<ul>
<li>5.给 dataTask 添加 Delegate (主要为 task 提供进度管理功能) </li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)addDelegateForDataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line">                uploadProgress:(nullable <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgressBlock</span><br><span class="line">              downloadProgress:(nullable <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgressBlock</span><br><span class="line">             completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> responseObject, <span class="built_in">NSError</span> *error))completionHandler</span><br></pre></td></tr></table></figure>
<p>以上方法是调用链上的主要方法，将在下文逐一解释。</p>
<h3 id="1-Get_请求入口">1.Get 请求入口</h3><p>具体方法体如下:</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// 创建这个 NSURLSessionDataTask</span><br><span class="line">   NSURLSessionDataTask <span class="keyword">*</span>dataTask = [self dataTaskWithHTTPMethod:<span class="comment">@"GET"</span></span><br><span class="line">                                                       URLString:URLString</span><br><span class="line">                                                      parameters:parameters</span><br><span class="line">                                                  uploadProgress:nil</span><br><span class="line">                                                downloadProgress:downloadProgress</span><br><span class="line">                                                         success:success</span><br><span class="line">                                                         failure:failure];</span><br><span class="line">/<span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line">    <span class="keyword">*</span>  session task的几种状态的操作函数</span><br><span class="line">       suspend -- 可以让当前的任务暂停</span><br><span class="line">       resume ---- 方法不仅可以启动任务,还可以唤醒suspend状态的任务</span><br><span class="line">       cancel ----- 方法可以取消当前的任务,你也可以向处于suspend状态的任务发送cancel消息,任务如果被取消便不能再恢复到之前的状态.</span><br><span class="line">    <span class="keyword">*</span>/</span><br><span class="line">   [dataTask resume];</span><br></pre></td></tr></table></figure>
<p>使用 GET 类型的 Request 来创建并运行一个 NSURLSessionDataTask，这里要注意的是用<code>[dataTask resume]</code>来开启这个 task。</p>
<h3 id="2-创建_NSURLSessionDataTask">2.创建 NSURLSessionDataTask</h3><p>主要方法体如下：</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">   <span class="comment">// 创建 NSMutableURLRequest</span></span><br><span class="line">   NSMutableURLRequest *request = [<span class="keyword">self</span>.requestSerializer requestWithMethod:<span class="function"><span class="keyword">method</span> <span class="title">URLString</span>:</span>[[NSURL URLWithString:URLString relativeToURL:<span class="keyword">self</span>.baseURL] absoluteString] parameters:parameters error:&amp;serializationError];</span><br><span class="line">   <span class="comment">// 处理构建 request 产生的错误</span></span><br><span class="line">	...</span><br><span class="line">   <span class="comment">// 创建 dataTask</span></span><br><span class="line">   __block NSURLSessionDataTask *dataTask = <span class="keyword">nil</span>;</span><br><span class="line">   dataTask = [<span class="keyword">self</span> dataTaskWithRequest:request</span><br><span class="line">                         uploadProgress:uploadProgress</span><br><span class="line">                       downloadProgress:downloadProgress</span><br><span class="line">                      completionHandler:^(NSURLResponse * __unused response, id responseObject, NSError *error) <span class="comment">&#123;</span><br><span class="line">       if (error) &#123;</span><br><span class="line">           if (failure) &#123;</span><br><span class="line">               failure(dataTask, error);</span><br><span class="line">           &#125;</span></span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="comment">&#123;</span><br><span class="line">           if (success) &#123;</span><br><span class="line">               success(dataTask, responseObject);</span><br><span class="line">           &#125;</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;];</span><br><span class="line"></span><br><span class="line">   return dataTask;</span><br></pre></td></tr></table></figure>
<p><code>dataTaskWithHTTPMethod:</code>这个函数的实现主要分两部分，一部分是构建NSMutableURLRequest，另一部分是根据已构建好的 Request 来创建 DataTask。<br>其中 Request 是由传递的 method 来创建，这里传递的是 GET，其它参数还有HEAD、POST、PUT、PATCH、DELETE 。</p>
<h3 id="3-创建_NSMutableURLRequest">3.创建 NSMutableURLRequest</h3><p>使用指定的 HTTP method 和 URLString 来构建一个 NSMutableURLRequest 对象实例，主要方法体如下：</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> 	// 参数断言</span><br><span class="line">   <span class="type">NSParameterAssert</span>(<span class="keyword">method</span>);</span><br><span class="line">   <span class="type">NSParameterAssert</span>(<span class="type">URLString</span>);</span><br><span class="line"></span><br><span class="line">   <span class="type">NSURL</span> *url = [<span class="type">NSURL</span> <span class="type">URLWithString</span>:<span class="type">URLString</span>];</span><br><span class="line"></span><br><span class="line">   <span class="type">NSParameterAssert</span>(url);</span><br><span class="line"></span><br><span class="line">   // 使用url构建并初始化<span class="type">NSMutableURLRequest</span>，然后设置<span class="type">HTTPMethod</span></span><br><span class="line">   <span class="type">NSMutableURLRequest</span> *mutableRequest = [[<span class="type">NSMutableURLRequest</span> alloc] initWithURL:url];</span><br><span class="line">   mutableRequest.<span class="type">HTTPMethod</span> = <span class="keyword">method</span>;</span><br><span class="line"></span><br><span class="line">   // 给<span class="type">NSMutableURLRequest</span>自带的属性赋值</span><br><span class="line">   // 然后通过判断mutableObservedChangedKeyPaths（<span class="type">NSMutableSet</span>）中是否有这个keyPath，来设定mutableRequest对应的keyPath值</span><br><span class="line">   // <span class="type">AFHTTPRequestSerializerObservedKeyPaths</span>这个数组里的属性是固定的，且在 init 方法里全都 <span class="type">KVO</span> 了</span><br><span class="line">   /**</span><br><span class="line">    *  当 <span class="type">AFHTTPRequestSerializerObserverContext</span> 中有 value 变化了(且变化后的新值不为 <span class="type">NSNull</span> null)，就会响应 observerValueForKeyPath 这个函数，从而mutableObservedChangedKeyPaths就会添加这个 keyPath</span><br><span class="line">    */</span><br><span class="line">   <span class="keyword">for</span> (<span class="type">NSString</span> *keyPath <span class="keyword">in</span> <span class="type">AFHTTPRequestSerializerObservedKeyPaths</span>()) &#123;</span><br><span class="line">       <span class="keyword">if</span> ([self.mutableObservedChangedKeyPaths containsObject:keyPath]) &#123;</span><br><span class="line">           [mutableRequest setValue:[self valueForKeyPath:keyPath] forKey:keyPath];</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   // 将传入的parameters进行编码，并添加到request中</span><br><span class="line">   /**</span><br><span class="line">    *  一般我们请求都会按key=value的方式带上各种参数，<span class="type">GET</span>方法参数直接加在<span class="type">URL</span>上，<span class="type">POST</span>方法放在body上，<span class="type">NSURLRequest</span>没有封装好这个参数的解析，只能我们自己拼好字符串。<span class="type">AFNetworking</span>提供了接口，让参数可以是<span class="type">NSDictionary</span>, <span class="type">NSArray</span>, <span class="type">NSSet</span>这些类型，再由内部解析成字符串后赋给<span class="type">NSURLRequest</span>。</span><br><span class="line">    */</span><br><span class="line">   mutableRequest = [[self requestBySerializingRequest:mutableRequest withParameters:parameters error:error] mutableCopy];</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> mutableRequest;</span><br></pre></td></tr></table></figure>
<p> 如果 method 是 GET、HEAD、DELETE，那 parameter 将会被用来构建一个基于 url 编码的查询字符串（query url），并且这个字符串会直接加到request的url后面。对于 POST/PUT，它们会根据 parameterEncoding 属性进行编码，而后加到 request 的 http body 上。</p>
<h3 id="4-用_request_创建_NSURLSessionDataTask">4.用 request 创建 NSURLSessionDataTask</h3><p>主要方法体如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="built_in">NSURLSessionDataTask</span> *dataTask = <span class="literal">nil</span>;</span><br><span class="line"><span class="comment">// 解决iOS8之前的一个bug</span></span><br><span class="line">url_session_manager_create_task_safely(^&#123;</span><br><span class="line">    <span class="comment">//  用NSURLSession创建NSURLSessionDataTask</span></span><br><span class="line">    dataTask = [<span class="keyword">self</span><span class="variable">.session</span> dataTaskWithRequest:request];</span><br><span class="line">&#125;);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>用 NSURLSession 的 <code>dataTaskWithRequest:</code>方法来创建 dataTask，这里需要注意的是方法被一个<code>url_session_manager_create_task_safely</code>的 block 包起来，这里是为了解决 iOS 8 上的一个 <a href="https://github.com/AFNetworking/AFNetworking/issues/2093" target="_blank" rel="external">bug</a>。</p>
<h3 id="5-给_dataTask_添加_Delegate">5.给 dataTask 添加 Delegate</h3><p>在这个方法里给 dataTask 添加了一个 AFURLSessionManagerTaskDelegate，并为 dataTask 提供进度管理功能，具体的是在<code>[self setDelegate:delegate forTask:dataTask]</code>方法：</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">NSParameterAssert(task);</span><br><span class="line">   NSParameterAssert(<span class="keyword">delegate</span>);</span><br><span class="line"></span><br><span class="line">   [<span class="keyword">self</span>.lock lock];</span><br><span class="line">   <span class="keyword">self</span>.mutableTaskDelegatesKeyedByTaskIdentifier[@(task.taskIdentifier)] = <span class="keyword">delegate</span>;</span><br><span class="line">   <span class="comment">// 设置uploadProgress和downloadProgress这两个NSProgress变量</span></span><br><span class="line">   [<span class="keyword">delegate</span> setupProgressForTask:task];</span><br><span class="line">   <span class="comment">// 给session task添加KVO</span></span><br><span class="line">   [<span class="keyword">self</span> addNotificationObserverForTask:task];</span><br><span class="line">   [<span class="keyword">self</span>.lock unlock];</span><br></pre></td></tr></table></figure>
<p>这里首先把<code>task.taskIdentifier</code>作为 key，<code>delegate</code> 作为 value 存在一个 MutableDictionary 里，然后设置上传和下载两个 progress，并给 task 添加上启动和暂停的 KVO。</p>
<h3 id="小结">小结</h3><p>通过这个流程可以初步了解 AFNetworking 内部方法调用关系，当然也可以看出其实 AFNetworking 就是对 NSURLSession 的高度地封装。随后的文章会结合源码，来深入理解 AFNetworking 的实现原理。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2016/09/29/afnetworking-2/" class="prev">上一篇</a><a href="/2016/08/22/simpleweather/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'v2panda-com';
var disqus_identifier = '2016/09/26/afnetworking-1/';
var disqus_title = 'AFNetworking 源码阅读笔记（一）';
var disqus_url = 'http://v2panda.com/2016/09/26/afnetworking-1/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//v2panda-com.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2018 <a href="http://v2panda.com">熊猫</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>